
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>water_tools &#8212; pyDeltaRCM 2.0.3 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="sed_tools" href="../sed_tools/index.html" />
    <link rel="prev" title="init_tools" href="../init_tools/index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../sed_tools/index.html" title="sed_tools"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../init_tools/index.html" title="init_tools"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyDeltaRCM 2.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">API reference</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">water_tools</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="water-tools">
<h1>water_tools<a class="headerlink" href="#water-tools" title="Permalink to this headline">¶</a></h1>
<p>The <a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.route_water" title="pyDeltaRCM.water_tools.water_tools.route_water"><code class="xref py py-obj docutils literal notranslate"><span class="pre">route_water</span></code></a> routine manages the water routing.
During <a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.route_water" title="pyDeltaRCM.water_tools.water_tools.route_water"><code class="xref py py-obj docutils literal notranslate"><span class="pre">route_water</span></code></a>, water iteration is repeated a total of <a class="reference internal" href="../../_autosummary/pyDeltaRCM.model.DeltaModel.html#pyDeltaRCM.model.DeltaModel.itermax" title="pyDeltaRCM.model.DeltaModel.itermax"><code class="xref py py-obj docutils literal notranslate"><span class="pre">itermax</span></code></a> times.
During each of these iterations of the water routing, the following methods are called <em>in order</em>:</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.init_water_iteration" title="pyDeltaRCM.water_tools.water_tools.init_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">water_tools.init_water_iteration</span></code></a>()</p></td>
<td><p>Init the water iteration routine.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.run_water_iteration" title="pyDeltaRCM.water_tools.water_tools.run_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">water_tools.run_water_iteration</span></code></a>()</p></td>
<td><p>Run a single iteration of travel paths for all water parcels.</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.compute_free_surface" title="pyDeltaRCM.water_tools.water_tools.compute_free_surface"><code class="xref py py-obj docutils literal notranslate"><span class="pre">water_tools.compute_free_surface</span></code></a>()</p></td>
<td><p>Calculate free surface after routing all water parcels.</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.finalize_water_iteration" title="pyDeltaRCM.water_tools.water_tools.finalize_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">water_tools.finalize_water_iteration</span></code></a>(iteration)</p></td>
<td><p>Finish updating flow fields.</p></td>
</tr>
</tbody>
</table>
<section id="public-api-methods-attached-to-model">
<h2>Public API methods attached to model<a class="headerlink" href="#public-api-methods-attached-to-model" title="Permalink to this headline">¶</a></h2>
<p>The following methods are defined in the <code class="docutils literal notranslate"><span class="pre">water_tools</span></code> class, of the <code class="docutils literal notranslate"><span class="pre">pyDeltaRCM.water_tools</span></code> module.</p>
<table class="longtable docutils align-default">
<colgroup>
<col style="width: 10%" />
<col style="width: 90%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools" title="pyDeltaRCM.water_tools.water_tools"><code class="xref py py-obj docutils literal notranslate"><span class="pre">water_tools</span></code></a>()</p></td>
<td><p></p></td>
</tr>
</tbody>
</table>
<dl class="py class">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">water_tools</span></span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools" title="Permalink to this definition">¶</a></dt>
<dd><dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.build_weight_array">
<span class="sig-name descname"><span class="pre">build_weight_array</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">array</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">fix_edges</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">normalize</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.build_weight_array" title="Permalink to this definition">¶</a></dt>
<dd><p>Weighting array of neighbors.</p>
<p>Create np.array((8,L,W)) of quantity a
in each of the neighbors to a cell</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.check_for_boundary">
<span class="sig-name descname"><span class="pre">check_for_boundary</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">inds</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.check_for_boundary" title="Permalink to this definition">¶</a></dt>
<dd><p>Check whether parcels have reached the boundary.</p>
<p>Checks whether any parcels have reached the model boundaries. If they
have, then update the information in
<code class="xref py py-obj docutils literal notranslate"><span class="pre">free_surf_flag</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>inds</strong> (<code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code>) – Unraveled indicies of parcels.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.check_size_of_indices_matrix">
<span class="sig-name descname"><span class="pre">check_size_of_indices_matrix</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">it</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.check_size_of_indices_matrix" title="Permalink to this definition">¶</a></dt>
<dd><p>Check if step path matrix needs to be made larger.</p>
<p>Initial size of self.free_surf_walk_inds is half of self.stepmax
because the number of iterations doesn’t go beyond
that for many timesteps.</p>
<p>Once it reaches it &gt; self.stepmax/2 once, make the size
self.iter for all further timesteps</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.compute_free_surface">
<span class="sig-name descname"><span class="pre">compute_free_surface</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.compute_free_surface" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate free surface after routing all water parcels.</p>
<p>This method uses the <cite>free_surf_walk_inds</cite> matrix accumulated
during the routing of the water parcels (in
<a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.run_water_iteration" title="pyDeltaRCM.water_tools.water_tools.run_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run_water_iteration</span></code></a>) to determine the free surface. The
operations of the free surface computation are placed in a jitted
function <a class="reference internal" href="#pyDeltaRCM.water_tools._accumulate_free_surface_walks" title="pyDeltaRCM.water_tools._accumulate_free_surface_walks"><code class="xref py py-obj docutils literal notranslate"><span class="pre">_accumulate_free_surface_walks</span></code></a>. Following this
computation, the free surface is smoothed by steps in
<a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.finalize_free_surface" title="pyDeltaRCM.water_tools.water_tools.finalize_free_surface"><code class="xref py py-obj docutils literal notranslate"><span class="pre">finalize_free_surface</span></code></a>.</p>
<p>See <a class="footnote-reference brackets" href="#id3" id="id1">1</a> and <a class="footnote-reference brackets" href="#id4" id="id2">2</a> for a complete description of hydrodynamic
assumptions in the DeltaRCM model.</p>
<p class="rubric">Examples</p>
<p>The sequence of <cite>compute_free_surface</cite> is depicted in the figures
below. The first image depicts the “input” to <cite>compute_free_surface</cite>,
which is the current bed elevation, and the path of each water parcel
(cyan lines in right image).</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/compute_free_surface_inputs.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/compute_free_surface_inputs.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/compute_free_surface_inputs.png" class="plot-directive" src="../../_images/compute_free_surface_inputs.png" />
</figure>
<p>The <cite>compute_free_surface</cite> method then calls the
<a class="reference internal" href="#pyDeltaRCM.water_tools._accumulate_free_surface_walks" title="pyDeltaRCM.water_tools._accumulate_free_surface_walks"><code class="xref py py-obj docutils literal notranslate"><span class="pre">_accumulate_free_surface_walks</span></code></a> function to determine 1) the
number of times each cell has been visited by a water parcel
(<code class="docutils literal notranslate"><span class="pre">sfc_visit</span></code>), and 2) the <em>total sum of expected elevations</em> of the
water surface at each cell (<code class="docutils literal notranslate"><span class="pre">sfc_sum</span></code>).</p>
<p>The output from <a class="reference internal" href="#pyDeltaRCM.water_tools._accumulate_free_surface_walks" title="pyDeltaRCM.water_tools._accumulate_free_surface_walks"><code class="xref py py-obj docutils literal notranslate"><span class="pre">_accumulate_free_surface_walks</span></code></a> is then used to
calculate a new stage surface (<code class="docutils literal notranslate"><span class="pre">H_new</span></code>) based only on the water
parcel paths and expected water surface elevations, approximately as
<code class="docutils literal notranslate"><span class="pre">Hnew</span> <span class="pre">=</span> <span class="pre">sfc_sum</span> <span class="pre">/</span> <span class="pre">sfc_visit</span></code> (“computed Hnew” in figure below)</p>
<p>Following this step, a correction is applied forcing the new free
surface to be below sea level and above or equal to the land surface
elevation over the model domain (“stage” in figure below). This
surface <cite>Hnew</cite> is used in the following operation
<a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.finalize_free_surface" title="pyDeltaRCM.water_tools.water_tools.finalize_free_surface"><code class="xref py py-obj docutils literal notranslate"><span class="pre">finalize_free_surface</span></code></a>.</p>
<p>Finally, the updated water surface is
combined with the previous timestep’s water surface and an
underrelaxation coefficient
<a class="reference internal" href="../../_autosummary/pyDeltaRCM.model.DeltaModel.html#pyDeltaRCM.model.DeltaModel.omega_sfc" title="pyDeltaRCM.model.DeltaModel.omega_sfc"><code class="xref py py-obj docutils literal notranslate"><span class="pre">omega_sfc</span></code></a>.</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/compute_free_surface_outputs.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/compute_free_surface_outputs.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/compute_free_surface_outputs.png" class="plot-directive" src="../../_images/compute_free_surface_outputs.png" />
</figure>
<dl class="footnote brackets">
<dt class="label" id="id3"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>A reduced-complexity model for river delta formation – Part 1:
Modeling deltas with channel dynamics, M. Liang, V. R. Voller,
and C. Paola, Earth Surf. Dynam., 3, 67–86, 2015.
<a class="reference external" href="https://doi.org/10.5194/esurf-3-67-2015">https://doi.org/10.5194/esurf-3-67-2015</a></p>
</dd>
<dt class="label" id="id4"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>A reduced-complexity model for river delta formation – Part 2:
Assessment of the flow routing scheme, M. Liang, N. Geleynse,
D. A. Edmonds, and P. Passalacqua, Earth Surf. Dynam., 3,
87–104, 2015. <a class="reference external" href="https://doi.org/10.5194/esurf-3-87-2015">https://doi.org/10.5194/esurf-3-87-2015</a></p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.finalize_free_surface">
<span class="sig-name descname"><span class="pre">finalize_free_surface</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.finalize_free_surface" title="Permalink to this definition">¶</a></dt>
<dd><p>Finalize the water free surface.</p>
<p>This method occurs after the initial computation of the free surface,
and creates the new free surface by smoothing the newly computed free
surface with a jitted function (<a class="reference internal" href="#pyDeltaRCM.water_tools._smooth_free_surface" title="pyDeltaRCM.water_tools._smooth_free_surface"><code class="xref py py-obj docutils literal notranslate"><span class="pre">_smooth_free_surface</span></code></a>), and then
combining the old surface and new smoothed surface with
underrelaxation. Finally, a <a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.flooding_correction" title="pyDeltaRCM.water_tools.water_tools.flooding_correction"><code class="xref py py-obj docutils literal notranslate"><span class="pre">flooding_correction</span></code></a> is applied.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.finalize_water_iteration">
<span class="sig-name descname"><span class="pre">finalize_water_iteration</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iteration</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.finalize_water_iteration" title="Permalink to this definition">¶</a></dt>
<dd><p>Finish updating flow fields.</p>
<p>Clean up at end of water iteration</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.flooding_correction">
<span class="sig-name descname"><span class="pre">flooding_correction</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.flooding_correction" title="Permalink to this definition">¶</a></dt>
<dd><p>Flood dry cells along the shore if necessary.</p>
<p>Check the neighbors of all dry cells. If any dry cells have wet
neighbors, check that their stage is not higher than the bed elevation
of the center cell.
If it is, flood the dry cell.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.get_water_weight_array">
<span class="sig-name descname"><span class="pre">get_water_weight_array</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.get_water_weight_array" title="Permalink to this definition">¶</a></dt>
<dd><p>Get step direction weights for each cell.</p>
<p>This method is called once, before parcels are stepped, because the
weights do not change during the stepping of parcels.</p>
<p>See <a class="reference internal" href="../../info/hydrodynamics.html"><span class="doc">Hydrodynamics</span></a> for a description of the model design
and equations/algorithms for how water weights are determined.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>No computation actually occurs in this method. Internally, the
method calls the jitted <code class="xref py py-obj docutils literal notranslate"><span class="pre">_get_water_weight_array</span></code>, which in
turn loops through all of the cells in the model domain and
determines the water weight for that cell with
<code class="xref py py-obj docutils literal notranslate"><span class="pre">get_weight_sfc_int</span></code> and <a class="reference internal" href="#pyDeltaRCM.water_tools._get_weight_at_cell_water" title="pyDeltaRCM.water_tools._get_weight_at_cell_water"><code class="xref py py-obj docutils literal notranslate"><span class="pre">_get_weight_at_cell_water</span></code></a>.</p>
</div>
<p class="rubric">Examples</p>
<p>The following figure shows several examples of locations within the
model domain, and the corresponding water routing weights determined
for that location.</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/water_weights_examples.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/water_weights_examples.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/water_weights_examples.png" class="plot-directive" src="../../_images/water_weights_examples.png" />
</figure>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.get_wet_mask_nh">
<span class="sig-name descname"><span class="pre">get_wet_mask_nh</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.get_wet_mask_nh" title="Permalink to this definition">¶</a></dt>
<dd><p>Get wet mask.</p>
<p>Returns np.array((8,L,W)), for each neighbor around a cell
with 1 if the neighbor is wet and 0 if dry</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.init_water_iteration">
<span class="sig-name descname"><span class="pre">init_water_iteration</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.init_water_iteration" title="Permalink to this definition">¶</a></dt>
<dd><p>Init the water iteration routine.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.route_water">
<span class="sig-name descname"><span class="pre">route_water</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.route_water" title="Permalink to this definition">¶</a></dt>
<dd><p>Water routing main method.</p>
<p>This is the main method for water routing in the model. It is
called once per <cite>update()</cite> call.</p>
<dl class="simple">
<dt>Internally, this method calls:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.init_water_iteration" title="pyDeltaRCM.water_tools.water_tools.init_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">init_water_iteration</span></code></a></p></li>
<li><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.run_water_iteration" title="pyDeltaRCM.water_tools.water_tools.run_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">run_water_iteration</span></code></a></p></li>
<li><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.compute_free_surface" title="pyDeltaRCM.water_tools.water_tools.compute_free_surface"><code class="xref py py-obj docutils literal notranslate"><span class="pre">compute_free_surface</span></code></a></p></li>
<li><p><a class="reference internal" href="#pyDeltaRCM.water_tools.water_tools.finalize_water_iteration" title="pyDeltaRCM.water_tools.water_tools.finalize_water_iteration"><code class="xref py py-obj docutils literal notranslate"><span class="pre">finalize_water_iteration</span></code></a></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.run_water_iteration">
<span class="sig-name descname"><span class="pre">run_water_iteration</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.run_water_iteration" title="Permalink to this definition">¶</a></dt>
<dd><p>Run a single iteration of travel paths for all water parcels.</p>
<p>Runs all water  parcels (<cite>Np_water</cite> parcels) for <cite>stepmax</cite> steps, or
until the parcels reach a boundary.</p>
<p>All parcels are processed in parallel, taking one step for each loop
of the <code class="docutils literal notranslate"><span class="pre">while</span></code> loop.</p>
<p class="rubric">Example</p>
<p>On the initial delta surface, see how ten selected parcels are routed through the domain:</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/run_water_iteration.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/run_water_iteration.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/run_water_iteration.png" class="plot-directive" src="../../_images/run_water_iteration.png" />
</figure>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.update_Q">
<span class="sig-name descname"><span class="pre">update_Q</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">dist</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">current_inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">next_inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">astep</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">jstep</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">istep</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update_current</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">update_next</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.update_Q" title="Permalink to this definition">¶</a></dt>
<dd><p>Update discharge field values.</p>
<p>Method is called after one set of water parcel steps.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.update_flow_field">
<span class="sig-name descname"><span class="pre">update_flow_field</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">iteration</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.update_flow_field" title="Permalink to this definition">¶</a></dt>
<dd><p>Update water discharge.</p>
<p>Update the water discharge field after one set of water parcels
iteration.</p>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools.water_tools.update_velocity_field">
<span class="sig-name descname"><span class="pre">update_velocity_field</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools.water_tools.update_velocity_field" title="Permalink to this definition">¶</a></dt>
<dd><p>Update flow velocity fields.</p>
<p>Update the flow velocity fields after one set of water parcels
iteration.</p>
</dd></dl>

</dd></dl>

</section>
<section id="water-tools-helper-functions">
<h2>water_tools helper functions<a class="headerlink" href="#water-tools-helper-functions" title="Permalink to this headline">¶</a></h2>
<p>The following routines are jitted for speed.
They generally take a large number of arrays and constants and return a new array(s) to continue with the model progression within the methods defined above.</p>
<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._get_weight_at_cell_water">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_get_weight_at_cell_water</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">ind</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_sfc</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">weight_int</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">depth_nbrs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ct_nbrs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dry_depth</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">gamma</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">theta</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._get_weight_at_cell_water" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute water weights for a given cell.</p>
<p>This is a jitted function called by <code class="xref py py-func docutils literal notranslate"><span class="pre">_get_water_weight_array()</span></code>.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._choose_next_directions">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_choose_next_directions</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">water_weights</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._choose_next_directions" title="Permalink to this definition">¶</a></dt>
<dd><p>Get new cell locations, based on water weights.</p>
<dl class="simple">
<dt>Algorithm is to:</dt><dd><ol class="arabic simple">
<li><p>loop through each parcel, which is described by a pair in the
<cite>inds</cite> array.</p></li>
<li><p>determine the water weights for that location (from <cite>water_weights</cite>)</p></li>
<li><p>choose a new cell based on the probabilities of the weights (using
the <cite>random_pick</cite> function)</p></li>
</ol>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>inds</strong> (<code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code>) – Current unraveled indices of the parcels. <code class="docutils literal notranslate"><span class="pre">(N,)</span></code>  <cite>ndarray</cite>
containing the unraveled indices.</p></li>
<li><p><strong>water_weights</strong> (<code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code>) – Weights of every water cell. <code class="docutils literal notranslate"><span class="pre">(LxW,</span> <span class="pre">9)</span></code> <cite>ndarray</cite>, uses unraveled
indicies along 0th dimension; 9 cells represent self and 8 neighboring
cells.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><strong>next_direction</strong> – The direction to move towards the new cell for water parcels, relative
to the current location. I.e., this is the D8 direction the parcel is
going to travel in the next stage,
<code class="xref py py-obj docutils literal notranslate"><span class="pre">pyDeltaRCM.shared_tools._calculate_new_ind</span></code>.</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p><code class="xref py py-obj docutils literal notranslate"><span class="pre">ndarray</span></code></p>
</dd>
</dl>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._calculate_new_inds">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_calculate_new_inds</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">current_inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_direction</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ravel_walk</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._calculate_new_inds" title="Permalink to this definition">¶</a></dt>
<dd><p>Calculate the new location (current_inds) of parcels.</p>
<p>Use the information of the current parcel (<cite>current_inds</cite>) in conjunction
with the D8 direction the parcel needs to travel (<cite>new_direction</cite>) to
determine the new current_inds of each parcel.</p>
<p>In implementation, we use the flattened <cite>ravel_walk</cite> array, but the result
is identical to unraveling the index, adding <cite>iwalk</cite> and <cite>jwalk</cite> to the
location and then raveling the index back.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ind_tuple</span> <span class="o">=</span> <span class="n">shared_tools</span><span class="o">.</span><span class="n">custom_unravel</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">domain_shape</span><span class="p">)</span>
<span class="n">new_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind_tuple</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">jwalk</span><span class="p">[</span><span class="n">newd</span><span class="p">],</span>
           <span class="n">ind_tuple</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">iwalk</span><span class="p">[</span><span class="n">newd</span><span class="p">])</span>
<span class="n">new_inds</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">shared_tools</span><span class="o">.</span><span class="n">custom_ravel</span><span class="p">(</span><span class="n">new_ind</span><span class="p">,</span> <span class="n">domain_shape</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._check_for_loops">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_check_for_loops</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">free_surf_walk_inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">new_inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">_step</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">L0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">CTR</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">stage_above_SL</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._check_for_loops" title="Permalink to this definition">¶</a></dt>
<dd><p>Check for loops in water parcel pathways.</p>
<p>Look for looping random walks. I.e., this function checks for where a
parcel will return on its <code class="xref py py-obj docutils literal notranslate"><span class="pre">new_inds</span></code> to somewhere it has already been
in <code class="xref py py-obj docutils literal notranslate"><span class="pre">free_surf_walk_inds</span></code>. If the loop is found, the parcel is
relocated along the mean transport vector of the parcel, which is computed
as the vector from the cell <cite>(0, CTR)</cite> to the new location in <cite>new_inds</cite>.</p>
<p>This implementation of loop checking will relocate any parcel that has
looped, but only disqualifies a parcel <cite>p</cite> from contributing to the free
surface in <code class="xref py py-obj docutils literal notranslate"><span class="pre">_accumulate_free_surf_walks</span></code> (i.e., <cite>looped[p] == 1</cite>) if
the stage at the looped location is above the sea level in the domain.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>free_surf_walk_inds</strong> – Array recording the walk of parcels. Shape is <cite>(:obj:`Np_water</cite>,
…)`, where the second dimension will depend on the step number, but
records each step of the parcel. Each element in the array records the
<em>flat</em> index into the domain.</p></li>
<li><p><strong>new_inds</strong> – Array recording the new index for each water parcel, if the step is
taken. Shape is <cite>(Np_water, 1)</cite>, with each element recording
the <em>flat</em> index into the domain shape.</p></li>
<li><p><strong>_step</strong> – Step number of water parcels.</p></li>
<li><p><strong>L0</strong> – Domain shape parameter, number of cells inlet length.</p></li>
<li><p><strong>CTR</strong> – Domain shape parameter, index along inlet wall making the center of
the domain. I.e., <cite>(0, CTR)</cite> is the midpoint across the inlet, along
the inlet domain edge.</p></li>
<li><p><strong>stage_above_SL</strong> – Water surface elevation minuns the domain sea level.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><em>new_inds</em> – An updated array of parcel indicies, where the index of a parcel has
been changed, if and only if, that parcel was looped.</p></li>
<li><p><em>looped</em> – A binary integer array indicating whether a parcel was determined to
have been looped, and should be disqualified from the free surface
computation.</p></li>
</ul>
</p>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>The following shows an example of how water parcels that looped along
their paths would be relocated. Note than in this example, the parcels are
artificially forced to loop, just for the sake of demonstration.</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/_check_for_loops.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/_check_for_loops.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/_check_for_loops.png" class="plot-directive" src="../../_images/_check_for_loops.png" />
</figure>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._update_dirQfield">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_update_dirQfield</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">qfield</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dist</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">astep</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dirstep</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._update_dirQfield" title="Permalink to this definition">¶</a></dt>
<dd><p>Update unit vector of water flux in x or y.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._update_absQfield">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_update_absQfield</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">qfield</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dist</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">astep</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">Qp_water</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dx</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._update_absQfield" title="Permalink to this definition">¶</a></dt>
<dd><p>Update norm of water flux vector.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._accumulate_free_surface_walks">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_accumulate_free_surface_walks</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">free_surf_walk_inds</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">free_surf_flag</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cell_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">uw</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ux</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">uy</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">depth</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">dx</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">u0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">h0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">H_SL</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">S0</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._accumulate_free_surface_walks" title="Permalink to this definition">¶</a></dt>
<dd><p>Accumulate the free surface by walking parcel paths.</p>
<p>This routine comprises the hydrodynamic physics-based computations.</p>
<dl class="simple">
<dt>Algorithm is to:</dt><dd><ol class="arabic simple">
<li><p>loop through every parcel’s directed random walk in series.</p></li>
<li><p>for a parcel’s walk, unravel the indices and determine whether the
parcel should contribute to the free surface. Parcels are
considered contributors if they have reached the ocean and if they
are not looped pathways.</p></li>
<li><p>then, we begin at the downstream end of the parcel’s walk and
iterate up-walk until, determining the <cite>Hnew</cite> for each location.
Downstream of the shoreline-ocean boundary, the water surface
elevation is set to the sea level. Upstream of the shoreline-ocean
boundary, the water surface is determined according to the
land-slope (<code class="xref py py-obj docutils literal notranslate"><span class="pre">S0</span></code>) and the parcel pathway.</p></li>
<li><p>repeat from 2, for each parcel.</p></li>
</ol>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>The following shows an example of the walk of a few water parcels, along
with the resultant computed water surface.</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/_accumulate_free_surface_walks.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/_accumulate_free_surface_walks.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/_accumulate_free_surface_walks.png" class="plot-directive" src="../../_images/_accumulate_free_surface_walks.png" />
</figure>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyDeltaRCM.water_tools._smooth_free_surface">
<span class="sig-prename descclassname"><span class="pre">pyDeltaRCM.water_tools.</span></span><span class="sig-name descname"><span class="pre">_smooth_free_surface</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">Hin</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">cell_type</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">Nsmooth</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">Csmooth</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#pyDeltaRCM.water_tools._smooth_free_surface" title="Permalink to this definition">¶</a></dt>
<dd><p>Smooth the free surface.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>Hin</strong> – Stage input to the smoothing (i.e., the old stage).</p></li>
<li><p><strong>cell_type</strong> – Type of each cell.</p></li>
<li><p><strong>Nsmooth</strong> – Number of times to smooth the free surface (i.e., stage)</p></li>
<li><p><strong>Csmooth</strong> – Underrelaxation coefficient for smoothing iterations.</p></li>
</ul>
</dd>
</dl>
<p class="rubric">Examples</p>
<p>The following shows an example of the water surface smoothing process.</p>
<p>(<a class="reference external" href="../../pyplots/water_tools/_smooth_free_surface.png">png</a>, <a class="reference external" href="../../pyplots/water_tools/_smooth_free_surface.hires.png">hires.png</a>)</p>
<figure class="align-default">
<img alt="../../_images/_smooth_free_surface.png" class="plot-directive" src="../../_images/_smooth_free_surface.png" />
</figure>
</dd></dl>

</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">water_tools</a><ul>
<li><a class="reference internal" href="#public-api-methods-attached-to-model">Public API methods attached to model</a></li>
<li><a class="reference internal" href="#water-tools-helper-functions">water_tools helper functions</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../init_tools/index.html"
                        title="previous chapter">init_tools</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../sed_tools/index.html"
                        title="next chapter">sed_tools</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/reference/water_tools/index.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../sed_tools/index.html" title="sed_tools"
             >next</a> |</li>
        <li class="right" >
          <a href="../init_tools/index.html" title="init_tools"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">pyDeltaRCM 2.0.3 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >API reference</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">water_tools</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, The DeltaRCM Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.1.2.
    </div>
  </body>
</html>