<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Changing topographic diffusion to represent tree throw &#8212; pyDeltaRCM 2.1.4 documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=649a27d8" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinxdoc.css?v=0a676766" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=fe69f605"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Defining custom YAML parameters" href="custom_yaml.html" />
    <link rel="prev" title="Time-varying inlet velocity" href="variable_velocity.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="custom_yaml.html" title="Defining custom YAML parameters"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="variable_velocity.html" title="Time-varying inlet velocity"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pyDeltaRCM 2.1.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Examples of using and working with pyDeltaRCM</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Changing topographic diffusion to represent tree throw</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="changing-topographic-diffusion-to-represent-tree-throw">
<h1>Changing topographic diffusion to represent tree throw<a class="headerlink" href="#changing-topographic-diffusion-to-represent-tree-throw" title="Permalink to this heading">¶</a></h1>
<p>Here, we demonstrate how to overwrite an existing method of the <cite>DeltaModel</cite> to achieve custom behavior during model runtime.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This example demonstrates several best-practices, including using yaml parameters specifications, custom figure and grid saving setup, and using <a class="reference internal" href="../reference/shared_tools/index.html#pyDeltaRCM.shared_tools.get_random_uniform" title="pyDeltaRCM.shared_tools.get_random_uniform"><code class="xref py py-obj docutils literal notranslate"><span class="pre">get_random_uniform</span></code></a> for random number generation.</p>
</div>
<p>In implementing custom model subclasses, it is common to want to change runtime behavior of the model.
This can often be achieved by using hooks alone, but sometimes a combination of hooks and overwriting existing methods is necessary.</p>
<p>In this example, we calculate a diffusion multiplier to represent tree throw.
In this super simple and <strong>likely way over-exaggerated</strong> representation of this process, we assume:</p>
<ul class="simple">
<li><p>there are trees everywhere the elevation of a cell has been above <cite>self.dry_depth</cite> for 10 consecutive timesteps</p></li>
<li><p>there is a probability threshold of tree throw occurring anywhere trees exist</p></li>
<li><p>tree throw makes the diffusion multiplier for that cell on that timestep really big!</p></li>
</ul>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>There are all kinds of problems with the assumptions in this example. Don’t read into it too much. It’s an example to show how to modify code, not how to represent tree throw.</p>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TreeThrowModel</span><span class="p">(</span><span class="n">pyDeltaRCM</span><span class="o">.</span><span class="n">DeltaModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Implementation of tree throw.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="c1"># inherit from base model</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">input_file</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook_after_create_domain</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">hook_import_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Define the custom YAML parameters.&quot;&quot;&quot;</span>
        <span class="c1"># whether to run vegetation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclass_parameters</span><span class="p">[</span><span class="s1">&#39;tree_throw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="kc">False</span>
        <span class="p">}</span>

        <span class="c1"># tree throw multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclass_parameters</span><span class="p">[</span><span class="s1">&#39;p_tt_mult&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">100</span>
        <span class="p">}</span>

        <span class="c1"># tree throw establish timesteps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclass_parameters</span><span class="p">[</span><span class="s1">&#39;p_tt_iter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mi">10</span>
        <span class="p">}</span>

        <span class="c1"># tree throw prob threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subclass_parameters</span><span class="p">[</span><span class="s1">&#39;p_tt_prob&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">],</span> <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="mf">0.2</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">hook_init_output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add non-standard grids, figures and metadata to be saved.&quot;&quot;&quot;</span>
        <span class="c1"># save a figure of the active layer each save_dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_fig_list</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span>

        <span class="c1"># save the active layer grid each save_dt w/ a short name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_var_list</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                                       <span class="s1">&#39;i4&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
                                              <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">hook_after_create_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add fields to the model for all tree parameterizations.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tree</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tree_multiplier</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">hook_after_route_sediment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply vegetation growth/death rules.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># determine cells dry and increment counter</span>
        <span class="n">_where_dry</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">dry_depth</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_count</span><span class="p">[</span><span class="o">~</span><span class="n">_where_dry</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># any wet gets reset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dry_count</span><span class="p">[</span><span class="n">_where_dry</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># any dry gets incremented</span>

        <span class="c1"># if tree_throw is on, run the tree placing routine</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree_throw</span><span class="p">:</span>

            <span class="c1"># trees die anywhere wet</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">[</span><span class="o">~</span><span class="n">_where_dry</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># trees go anywhere dry for more than threshold</span>
            <span class="n">_where_above_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dry_count</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_tt_iter</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">[</span><span class="n">_where_above_thresh</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># determine the multiplier field</span>
            <span class="n">_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">get_random_uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">size</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">_thrown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">((</span><span class="n">_rand</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_tt_prob</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>

            <span class="c1"># ignore the strip of land</span>
            <span class="n">_thrown</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># set to ones everywhere, then overwrite with multiplier</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_multiplier</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tree_multiplier</span><span class="p">[</span><span class="n">_thrown</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_tt_mult</span>

    <span class="k">def</span> <span class="nf">topo_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Overwrite with new behavior.</span>

<span class="sd">        This method is very similar to the base DeltaModel code, but we add an</span>
<span class="sd">        additional multiplier to represent tree throw.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_crossdiff</span><span class="p">):</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel2</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel2</span><span class="p">,</span>
                                 <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tree_multiplier</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusion_multiplier</span> <span class="o">*</span>
                       <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qs</span> <span class="o">*</span> <span class="n">a</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">*</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cf</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cf</span>
</pre></div>
</div>
<p>And the model is then instantiated with:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">mdl</span> <span class="o">=</span> <span class="n">TreeThrowModel</span><span class="p">(</span>
    <span class="n">tree_throw</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We don’t actually run this model at all in this example.
Let’s plot the <code class="docutils literal notranslate"><span class="pre">.tree</span></code> field just to see that the subclass was instantiated correctly.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">mdl</span><span class="o">.</span><span class="n">tree</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p>(<a class="reference download internal" download="" href="../_downloads/140d7315c10edebdd88b748b9e8c42eb/overwrite_topo_diffusion-3.png"><code class="xref download docutils literal notranslate"><span class="pre">png</span></code></a>, <a class="reference download internal" download="" href="../_downloads/6adcfad69b28e541f38f21663ca939f4/overwrite_topo_diffusion-3.hires.png"><code class="xref download docutils literal notranslate"><span class="pre">hires.png</span></code></a>)</p>
<figure class="align-default">
<img alt="../_images/overwrite_topo_diffusion-3.png" class="plot-directive" src="../_images/overwrite_topo_diffusion-3.png" />
</figure>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="variable_velocity.html"
                          title="previous chapter">Time-varying inlet velocity</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="custom_yaml.html"
                          title="next chapter">Defining custom YAML parameters</a></p>
  </div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/examples/overwrite_topo_diffusion.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="custom_yaml.html" title="Defining custom YAML parameters"
             >next</a> |</li>
        <li class="right" >
          <a href="variable_velocity.html" title="Time-varying inlet velocity"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">pyDeltaRCM 2.1.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Examples of using and working with pyDeltaRCM</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Changing topographic diffusion to represent tree throw</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2020, The DeltaRCM Team.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    </div>
  </body>
</html>